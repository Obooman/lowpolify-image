<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style>
		body{
			/*background-color: black;*/
			margin: 0;
		}

		canvas{
			background-color: white;
		}
	</style>
</head>
<body>
	<canvas width="1920" height="1000"></canvas>

	<script src="js/common.js"></script>
	<script src="js/Polygon.js"></script>
	<script src="js/Point.js"></script>
	<script src="js/Vector.js"></script>

	<script>
		var oC = document.querySelector('canvas');
		var ctx = oC.getContext('2d');

		var imageArray = null;

		// space size between point
		var step = 10;
		var points = [];
		var polygons = [];

		var oImage = new Image();
			oImage.src = "./demo.jpg";

		// generate low-poly trangle points
		for( let col = 0; col < oC.width/step + 3 ; col ++ ){
			for( let row = 0; row < oC.height/step + 3; row++ ){
				!points[row] && (points[row] = []);
				points[row][col] = new Point(col,row);
			}
		}

		oImage.onload = function(){
			ctx.drawImage(oImage,
				0,0,oImage.width,oImage.height,
				0,0,1920,1920/oImage.width*oImage.height
			)

			points.forEach(function(row){
				row.forEach(function(singlePoint){
					singlePoint.draw();
				})
			})

			ctx.strokeStyle="rgba(255,255,255,0.1)"
			ctx.stroke();

			imageArray = ctx.getImageData(0,0,oC.width,oC.height);
		}

		/*
		 * return related three points with given point
		 * @param point Point
		 * @return points Array
		 * @demo	
		 * 		[(→)Point,(↓)Point,(↘️)Point]
		 */

		function getPolygonPoints(pointO){

			/*

			let O == point

			O----P
			|    |
			|    |
			Q----R

			*/

			var lastRow = !points[pointO.y+1];
			var lastCol = !points[pointO.y][pointO.x+1];

			var pointP = lastRow ? null : points[pointO.y+1][pointO.x];
			var pointQ = lastCol ? null : points[pointO.y][pointO.x+1];
			var pointR = ( lastRow || lastCol ) ? null :points[pointO.y+1][pointO.x+1]

			pointO.name = "O";
			if( pointP ) pointP.name = "P";
			if( pointQ ) pointQ.name = "Q";
			if( pointR ) pointR.name = "R";

			return [pointP,pointQ,pointR];
		}

		/*
		 * getPoints within a given polygon
		 * @param polygon Polygon
		 * @return points Array
		 * @demo 
		 * 		[{x:x1,y:[y1,y2]},{x:x2,y:[y1,y2]}]
		 */

		 function getPoints(polygon){

		 	var newPoints = [].concat(polygon.points);
		 	var pointSet = [];

		 	var [
		 		a,b,c,d
		 	] = newPoints;

		 	// four side polygon
		 	if( d ){
		 		var polygonOne = new Polygon(a,b,c)
		 		var polygonTwo = new Polygon(a,c,d);

		 		return getPoints(polygonOne).concat(getPoints(polygonTwo));
		 	}

		 	newPoints.sort(function(a,b){
		 		return a.p.x - b.p.x
		 	});

		 	 /*
						· (x2,y2)

				·(x1,y1)	·(x3,y3)

		 	 */

		 	 var x1 = a.p.x;
		 	 var y1 = a.p.y;

		 	 var x2 = b.p.x;
		 	 var y2 = b.p.y;

		 	 var x3 = c.p.x;
		 	 var y3 = c.p.y;

		 	 // get the point in (x1,y1)-(x2,y2) line whose x equals to x2
		 	 var x4 = x2;
		 	 var y4 = (x2-x1)/(x1-x3)*(y1-y3) + y1;

		 	 var d = new Point(0,0);
		 	 	 d.p.x = x4;
		 	 	 d.p.y = y4;

	 	 	 // TODO return trangetSection().concat(trangetSection());
	 	 	 // Done

	 	 	 var leftHalf = trangleSection(a,b,d);
			 var rightHalf = trangleSection(c,b,d);

	 	 	 return leftHalf.concat(rightHalf);
		 }

		 function trangleSection(pointOne,pointTwo,pointThree){

		 	var pixelArray = [];

		 	// very left point
		 	var x1 = pointOne.p.x;
		 	var y1 = pointOne.p.y;

		 	// one of right point
		 	var x2 = pointTwo.p.x;
		 	var y2 = pointTwo.p.y;

		 	// one of right point
		 	var x3 = pointThree.p.x;
		 	var y3 = pointThree.p.y;

		 	// loop from leftX to rightX
		 	for( let x = Math.min(x1,x2); x < Math.max(x1,x2); x++ ){
		 		var percentage = (x-x1)/(x2-x1);

		 		// sort y range from small to big

		 		var yRange = [
		 			parseInt(percentage*(y2-y1)+y1),
		 			parseInt(percentage*(y3-y1)+y1)
					].sort((a,b) => a-b);

				if( yRange[1] == yRange[0] ){
					yRange[1] += 1;
				}

		 		pixelArray.push({
		 			x,
		 			y:yRange
		 		})
		 	}

		 	return pixelArray;
		 }


		 /*
		  * avgColor
		  * @param colorArray array
		  * @demo
		  * 	[[r,g,b,a],[r,g,b,a]]
		  * @return color String
		  * @demo
		  * 	"#029df9" / "rgb(0,12,21)"
		  */

		 function avgColor(colorArray){
		 	var r = 0;
		 	var g = 0;
		 	var b = 0;
		 	var a = 0;

		 	var count = colorArray.length;

		 	colorArray.forEach(function(color){
		 		r += Number(color[0]);
		 		g += Number(color[1]);
		 		b += Number(color[2]);
		 		a += Number(color[3]);
		 	})

		 	if( isNaN(r) || isNaN(g) || isNaN(b) || isNaN(a) ){
		 		// console.log( colorArray );
		 	}

		 	// return `#${(r/count).toString(16)}${(g/count).toString(16)}${(b/count).toString(16)}`
		 	return `rgba(${Math.round((r/count))},${Math.round((g/count))},${Math.round(b/count)},${(a/count/255)})`;
		 }

		 /*
		  * fill colors to every trangle
		  */

		 function fillColor(){
		 	var {
		 		width,
		 		height
		 	} = imageArray;

		 	polygons.forEach(function(polygon,index){
		 		var areaPoints = getPoints(polygon);
		 		var colorArray = [];

		 		areaPoints.forEach(function({x,y:[y1,y2]}){

		 			if( x< 0 || y1 <0 ){
		 				return;
		 			}

		 			for( var y = y1;y<y2;y++ ){

		 				var r = imageArray.data[(y*width+x)*4];
		 				var g = imageArray.data[(y*width+x)*4 + 1];
		 				var b = imageArray.data[(y*width+x)*4 + 2];
		 				var a = imageArray.data[(y*width+x)*4 + 3];

		 				colorArray.push([r,g,b,a]);
		 			}
		 		})

		 		polygon.draw(avgColor(colorArray));
		 	})
		 }
	</script>
</body>
</html>